
ALTER PROCEDURE VTA_REDONDEOS (@base VARCHAR (50), @agencia VARCHAR (4), @fecha VARCHAR (10)) AS
BEGIN

DECLARE @nSql NVARCHAR(4000) = ''

SET @nSql = @nSql+ 'SELECT '
SET @nSql = @nSql+ 'FORMA, MONEDA, SUM(DIF_MN) MN, SUM(DIF_US) US '
SET @nSql = @nSql+ 'FROM ( '
SET @nSql = @nSql+ 'SELECT FORMA, MONEDA, IIF(MONEDA=''MN'',MN-PAGOS_MN,0) DIF_MN, IIF(MONEDA=''US'',US-PAGOS_US,0) DIF_US '
SET @nSql = @nSql+ 'FROM ( '
SET @nSql = @nSql+ 'SELECT C.RP_CFORPAG FORMA, C.RP_CTIPMON MONEDA,  '
SET @nSql = @nSql+ 'C.RP_NIMPTMN MN, (SELECT SUM(P.FP_NIMPTMN) FROM '+@base+'..CC0001PAGO P WHERE P.FP_CTIPLIQ=C.RP_CTIPLIQ AND P.FP_CNROLIQ=C.RP_CNROLIQ AND P.FP_CITEM=C.RP_CITEM) PAGOS_MN, '
SET @nSql = @nSql+ 'C.RP_NIMPTUS US, (SELECT SUM(P.FP_NIMPTUS) FROM '+@base+'..CC0001PAGO P WHERE P.FP_CTIPLIQ=C.RP_CTIPLIQ AND P.FP_CNROLIQ=C.RP_CNROLIQ AND P.FP_CITEM=C.RP_CITEM) PAGOS_US '
SET @nSql = @nSql+ 'FROM '+@base+'..CC0001FORP C '
SET @nSql = @nSql+ 'WHERE C.RP_CFORPAG<>''A'' '
SET @nSql = @nSql+ 'AND C.RP_CLOCEMI='''+@agencia+''' '
SET @nSql = @nSql+ 'AND CONVERT(VARCHAR(10),C.RP_DFECHEB,103)='''+@fecha+''' '
SET @nSql = @nSql+ ') AS X 	WHERE (MONEDA=''MN'' AND MN<>PAGOS_MN) OR (MONEDA=''US'' AND US<>PAGOS_US) '
SET @nSql = @nSql+ ') AS  J '
SET @nSql = @nSql+ 'GROUP BY FORMA, MONEDA '
SET @nSql = @nSql+ 'ORDER BY FORMA, MONEDA'

EXEC sp_executesql @nSql

END
GO
