
CREATE PROCEDURE VTA_REDONDEOS
    @parameter1_name INT,
    @parameter2_name VARCHAR (20) = 'Default Value'
AS
BEGIN

SELECT
FORMA, MONEDA, SUM(DIF_MN) MN, SUM(DIF_US) US
FROM (
	SELECT FORMA, MONEDA, IIF(MONEDA='MN',MN-PAGOS_MN,0) DIF_MN, IIF(MONEDA='US',US-PAGOS_US,0) DIF_US
	FROM (
	SELECT C.RP_CFORPAG FORMA, C.RP_CTIPMON MONEDA,
	C.RP_NIMPTMN MN, (SELECT SUM(P.FP_NIMPTMN) FROM CC0001PAGO P WHERE P.FP_CTIPLIQ=C.RP_CTIPLIQ AND P.FP_CNROLIQ=C.RP_CNROLIQ AND P.FP_CITEM=C.RP_CITEM) PAGOS_MN,
	C.RP_NIMPTUS US, (SELECT SUM(P.FP_NIMPTUS) FROM CC0001PAGO P WHERE P.FP_CTIPLIQ=C.RP_CTIPLIQ AND P.FP_CNROLIQ=C.RP_CNROLIQ AND P.FP_CITEM=C.RP_CITEM) PAGOS_US
	FROM CC0001FORP C
	WHERE 1=1
	AND C.RP_CFORPAG<>'A'
	AND C.RP_CLOCEMI='6000'
	AND C.RP_DFECHEB='20180206'
	) AS X 	WHERE (MONEDA='MN' AND MN<>PAGOS_MN) OR (MONEDA='US' AND US<>PAGOS_US)
) AS  J
GROUP BY FORMA, MONEDA
ORDER BY FORMA, MONEDA

END

ss
